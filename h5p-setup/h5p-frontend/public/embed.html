<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H5P Content Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
      }
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .error {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background: #fee2e2;
        color: #dc2626;
        text-align: center;
        padding: 2rem;
      }
      .content-container {
        min-height: 100vh;
        background: white;
      }
      .h5p-content {
        max-width: 100%;
        margin: 0 auto;
        padding: 1rem;
      }
      .h5p-frame {
        width: 100%;
        min-height: 400px;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="loading" id="loading">
        <div class="text-center">
          <div
            class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto mb-4"
          ></div>
          <p class="text-lg">Loading H5P content...</p>
        </div>
      </div>
    </div>

    <script>
      class H5PEmbedViewer {
        constructor() {
          this.apiBaseUrl = "http://localhost:3000";
          this.app = document.getElementById("app");
          this.loading = document.getElementById("loading");
          this.init();
        }

        async init() {
          try {
            // Get content ID from URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const contentId = urlParams.get("contentId");

            if (!contentId) {
              this.showError(
                "No content ID provided. Use ?contentId=YOUR_CONTENT_ID"
              );
              return;
            }

            // Load content data
            const contentData = await this.loadContent(contentId);
            this.renderContent(contentData);
          } catch (error) {
            console.error("Error initializing H5P viewer:", error);
            this.showError(
              "Failed to load content. Please check the content ID and try again."
            );
          }
        }

        async loadContent(contentId) {
          const response = await fetch(
            `${this.apiBaseUrl}/h5p/player/${contentId}`
          );
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return await response.json();
        }

        renderContent(contentData) {
          this.loading.style.display = "none";

          const container = document.createElement("div");
          container.className = "content-container";

          // Create header with content info
          const header = document.createElement("div");
          header.className =
            "bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-lg";
          header.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <h1 class="text-2xl font-bold mb-2">${
                          contentData.data?.title || "H5P Content"
                        }</h1>
                        <p class="text-blue-100">${
                          contentData.data?.mainLibrary || "Interactive Content"
                        }</p>
                    </div>
                `;

          // Create content area
          const contentArea = document.createElement("div");
          contentArea.className = "h5p-content max-w-4xl mx-auto";

          if (contentData.mock) {
            // Show mock content
            contentArea.innerHTML = `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                            <div class="flex items-center mb-4">
                                <svg class="w-6 h-6 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                                <h2 class="text-lg font-semibold text-yellow-800">Demo Content</h2>
                            </div>
                            <p class="text-yellow-700 mb-4">This is sample content because H5P libraries are not installed.</p>
                            <div class="bg-white rounded-lg p-4 border border-yellow-200">
                                <h3 class="font-semibold mb-2">Content Preview:</h3>
                                <div class="text-gray-800">
                                    ${this.renderMockContent(contentData)}
                                </div>
                            </div>
                        </div>
                    `;
          } else {
            // Render actual H5P content
            contentArea.innerHTML = this.renderH5PContent(contentData);
          }

          // Add footer
          const footer = document.createElement("div");
          footer.className =
            "bg-gray-50 border-t border-gray-200 p-4 text-center text-gray-600";
          footer.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <p>Powered by H5P Content Management System</p>
                        <p class="text-sm mt-1">Content ID: ${contentData.contentId}</p>
                    </div>
                `;

          container.appendChild(header);
          container.appendChild(contentArea);
          container.appendChild(footer);
          this.app.appendChild(container);
        }

        renderMockContent(contentData) {
          const params = contentData.data?.parameters || {};

          if (contentData.data?.mainLibrary === "H5P.MultipleChoice 1.16") {
            return `
                        <div class="space-y-4">
                            <h4 class="font-semibold text-lg">${
                              params.question || "Sample Question"
                            }</h4>
                            <div class="space-y-2">
                                ${(params.answers || [])
                                  .map(
                                    (answer, index) => `
                                    <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                        <input type="radio" name="question" id="answer-${index}" class="mr-3">
                                        <label for="answer-${index}" class="flex-1 cursor-pointer">${
                                      answer.text || `Answer ${index + 1}`
                                    }</label>
                                        ${
                                          answer.correct
                                            ? '<span class="text-green-600 text-sm">‚úì Correct</span>'
                                            : ""
                                        }
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                        </div>
                    `;
          } else if (contentData.data?.mainLibrary === "H5P.Text 1.1") {
            return `
                        <div class="prose max-w-none">
                            <div class="text-gray-800 leading-relaxed">
                                ${params.text || "Sample text content..."}
                            </div>
                        </div>
                    `;
          } else {
            return `
                        <div class="text-gray-800">
                            <p>This content type (${contentData.data?.mainLibrary}) is not yet implemented in the demo.</p>
                            <p class="mt-2">Install H5P libraries to see the full interactive content.</p>
                        </div>
                    `;
          }
        }

        renderH5PContent(contentData) {
          // Render a preview of the content based on the content type
          const params = contentData.data?.parameters || {};

          if (contentData.data?.mainLibrary === "H5P.MultipleChoice 1.16") {
            return `
               <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                 <h3 class="text-xl font-semibold text-gray-900 mb-4">Interactive Quiz</h3>
                 <div class="space-y-4">
                   <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                     <h4 class="font-semibold text-blue-900 mb-2">Question:</h4>
                     <p class="text-blue-800">${
                       params.question || "Sample question text"
                     }</p>
                   </div>
                   <div class="space-y-3">
                     <h4 class="font-semibold text-gray-900">Answer Options:</h4>
                     ${(params.answers || [])
                       .map(
                         (answer, index) => `
                       <div class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                         <input type="radio" name="quiz-question" id="option-${index}" class="mr-3 text-blue-600">
                         <label for="option-${index}" class="flex-1 cursor-pointer text-gray-700">${
                           answer.text || `Option ${index + 1}`
                         }</label>
                         ${
                           answer.correct
                             ? '<span class="text-green-600 text-sm font-medium">‚úì Correct</span>'
                             : ""
                         }
                       </div>
                     `
                       )
                       .join("")}
                   </div>
                   <div class="flex justify-between items-center pt-4 border-t border-gray-200">
                     <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Submit Answer</button>
                     <span class="text-sm text-gray-500">Pass percentage: ${
                       params.passPercentage || 80
                     }%</span>
                   </div>
                 </div>
               </div>
             `;
          } else if (contentData.data?.mainLibrary === "H5P.Flashcards 1.0") {
            return `
               <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                 <h3 class="text-xl font-semibold text-gray-900 mb-4">Flashcards</h3>
                 <div class="space-y-4">
                   <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-6 text-center">
                     <div class="text-2xl mb-4">üÉè</div>
                     <h4 class="font-semibold text-purple-900 mb-2">Flashcard Preview</h4>
                     <p class="text-purple-700">${
                       (params.cards || []).length
                     } cards available</p>
                   </div>
                   <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     ${(params.cards || [])
                       .slice(0, 4)
                       .map(
                         (card, index) => `
                       <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                         <div class="text-sm text-gray-500 mb-2">Card ${
                           index + 1
                         }</div>
                         <div class="font-medium text-gray-900 mb-2">Front: ${
                           card.front || "Sample front text"
                         }</div>
                         <div class="text-gray-600">Back: ${
                           card.back || "Sample back text"
                         }</div>
                       </div>
                     `
                       )
                       .join("")}
                   </div>
                   <div class="flex justify-center pt-4">
                     <button class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors">Start Flashcards</button>
                   </div>
                 </div>
               </div>
             `;
          } else if (contentData.data?.mainLibrary === "H5P.Blanks 1.14") {
            return `
               <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                 <h3 class="text-xl font-semibold text-gray-900 mb-4">Fill in the Blanks</h3>
                 <div class="space-y-4">
                   <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                     <h4 class="font-semibold text-green-900 mb-2">Text with Blanks:</h4>
                     <div class="text-green-800 leading-relaxed">
                       ${this.renderBlanksPreview(
                         params.text || "Sample text with *blanks* to fill in."
                       )}
                     </div>
                   </div>
                   <div class="flex justify-center pt-4">
                     <button class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">Check Answers</button>
                   </div>
                 </div>
               </div>
             `;
          } else if (contentData.data?.mainLibrary === "H5P.DragAndDrop 1.0") {
            return `
               <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                 <h3 class="text-xl font-semibold text-gray-900 mb-4">Drag and Drop</h3>
                 <div class="space-y-4">
                   <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                     <h4 class="font-semibold text-orange-900 mb-2">Instructions:</h4>
                     <p class="text-orange-800">${
                       params.instructions ||
                       "Drag items to their correct positions."
                     }</p>
                   </div>
                   <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                       <h5 class="font-medium text-gray-900 mb-2">Draggable Items:</h5>
                       <div class="space-y-2">
                         ${(params.draggableItems || [])
                           .slice(0, 3)
                           .map(
                             (item, index) => `
                           <div class="bg-white border border-gray-300 rounded px-3 py-2 text-sm cursor-move hover:bg-gray-50">
                             ${item.text || `Item ${index + 1}`}
                           </div>
                         `
                           )
                           .join("")}
                       </div>
                     </div>
                     <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                       <h5 class="font-medium text-gray-900 mb-2">Drop Zones:</h5>
                       <div class="space-y-2">
                         ${(params.dropZones || [])
                           .slice(0, 3)
                           .map(
                             (zone, index) => `
                           <div class="border-2 border-dashed border-gray-300 rounded px-3 py-4 text-center text-gray-500">
                             ${zone.label || `Zone ${index + 1}`}
                           </div>
                         `
                           )
                           .join("")}
                       </div>
                     </div>
                   </div>
                   <div class="flex justify-center pt-4">
                     <button class="bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition-colors">Start Activity</button>
                   </div>
                 </div>
               </div>
             `;
          } else if (contentData.data?.mainLibrary === "H5P.Text 1.1") {
            return `
               <div class="bg-white rounded-lg border border-gray-200 p-6 shadow-sm">
                 <h3 class="text-xl font-semibold text-gray-900 mb-4">Text Content</h3>
                 <div class="prose max-w-none">
                   <div class="text-gray-800 leading-relaxed">
                     ${params.text || "Sample text content..."}
                   </div>
                 </div>
               </div>
             `;
          } else {
            return `
               <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                 <h3 class="text-lg font-semibold text-blue-900 mb-4">H5P Content Preview</h3>
                 <p class="text-blue-700 mb-4">Content type: ${
                   contentData.data?.mainLibrary || "Unknown"
                 }</p>
                 <div class="bg-white rounded border border-blue-200 p-4">
                   <h4 class="font-medium text-gray-900 mb-2">Content Data:</h4>
                   <pre class="text-sm text-gray-600 overflow-auto max-h-64">${JSON.stringify(
                     contentData,
                     null,
                     2
                   )}</pre>
                 </div>
               </div>
             `;
          }
        }

        renderBlanksPreview(text) {
          // Convert H5P blanks format (*correct/alternative*) to HTML input fields
          const blankPattern = /\*([^/]+)\/[^*]+\*/g;
          return text.replace(blankPattern, (match, correctAnswer) => {
            return `<input type="text" class="mx-1 px-2 py-1 border border-gray-300 rounded text-sm min-w-[80px] focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Answer" data-correct="${correctAnswer.trim()}">`;
          });
        }

        showError(message) {
          this.loading.style.display = "none";
          this.app.innerHTML = `
                     <div class="error">
                         <div class="text-center">
                             <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                             </svg>
                             <h2 class="text-xl font-semibold mb-2">Error Loading Content</h2>
                             <p class="text-lg">${message}</p>
                         </div>
                     </div>
                 `;
        }
      }

      // Initialize the viewer when the page loads
      document.addEventListener("DOMContentLoaded", () => {
        new H5PEmbedViewer();
      });

      // Handle messages from parent window (for iframe communication)
      window.addEventListener("message", (event) => {
        if (event.data.type === "H5P_RESIZE") {
          // Handle iframe resize requests
          const height = event.data.height;
          if (height) {
            window.parent.postMessage(
              {
                type: "H5P_IFRAME_RESIZE",
                height: height,
              },
              "*"
            );
          }
        }
      });
    </script>
  </body>
</html>
